(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["011665ee"],{"52f1":function(e,t,s){"use strict";var a=s("8ae4"),i=s.n(a);i.a},"7f76":function(e,t,s){"use strict";s.r(t);var a=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("q-page",[s("div",{staticClass:"bg-white row border-grey fit",staticStyle:{"min-height":"500px"},style:e.dom.divSize?"min-height: "+e.dom.divSize+"px !important; max-height: "+e.dom.divSize+"px !important;":""},[e.$q.platform.is.desktop||!e.activeFriend.id?s("q-list",{staticClass:"rounded-borders full-height",class:e.$q.platform.is.desktop?"col-3":"col-12",style:"max-height: "+e.dom.chatContainerHeight+"px",attrs:{bordered:""}},[s("q-item-label",{attrs:{header:""}},[e._v(e._s(e.$tc("friend",2)))]),e._l(e.friends,function(t){return s("q-item",{directives:[{name:"ripple",rawName:"v-ripple"}],key:t.user.id,class:e.activeFriend.id===t.user.id?"bg-grey-4":"",attrs:{clickable:""},on:{click:function(s){return e.friendSelect(t)}}},[s("q-item-section",{attrs:{avatar:""}},[s("user-avatar",{attrs:{"user-id":t.user.id,size:"48px"}})],1),s("q-item-section",[s("q-item-label",{staticClass:"text-weight-bold",attrs:{lines:"1"}},[e._v("\n              "+e._s(t.user.name)+" "+e._s(t.user.lastName)+"\n            ")]),t.lastMessage?s("q-item-label",{staticClass:"text-weight-bold text-grey-7",attrs:{caption:"",lines:"2"}},[e._v("\n              "+e._s(t.lastMessage.text)+"\n            ")]):e._e()],1),t.lastMessage?s("q-item-section",{attrs:{lines:"2",side:"",bottom:""}},[s("q-item-label",{staticClass:"text-weight-bold",attrs:{caption:""}},[e._v("\n              "+e._s(e.$dateFromNow(t.lastMessage.sentAt))+"\n            ")]),t.unreadMessages>0?s("q-item-label",{staticClass:"text-weight-bold",attrs:{caption:""}},[s("q-badge",{attrs:{color:"deep-purple"}},[e._v("\n                "+e._s(t.unreadMessages)+"\n              ")])],1):e._e()],1):e._e()],1)}),s("q-separator",{attrs:{inset:"item"}})],2):e._e(),e.$q.platform.is.desktop||e.activeFriend.id?s("div",{staticClass:"bg-deep-purple-1 border border-grey-left column reverse",class:e.$q.platform.is.desktop?"col-9":"col-12"},[s("div",{class:e.$q.platform.is.desktop?"":"fixed-bottom",style:e.$q.platform.is.desktop?"":"z-index: 9999;"},[s("q-input",{staticClass:"q-px-xl q-pt-md bg-white",attrs:{outlined:"","bottom-slots":"",label:e.$tc("message"),maxlength:"120",counter:"",color:"dark-purple","bg-color":"deep-purple-1",loading:e.sendingMessage,disable:e.sendingMessage},nativeOn:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.sendMessage(t)}},scopedSlots:e._u([{key:"after",fn:function(){return[s("q-btn",{attrs:{round:"",dense:"",flat:"",icon:"send"},on:{click:e.sendMessage}})]},proxy:!0}],null,!1,3043567891),model:{value:e.textMessage,callback:function(t){e.textMessage=t},expression:"textMessage"}})],1),s("div",{ref:"chatContainer",staticClass:"self-center",staticStyle:{width:"100%","overflow-y":"auto"},style:e.$q.platform.is.desktop?"max-height: "+e.dom.chatContainerHeight+"px":"margin-bottom: 100px; max-height: "+e.dom.chatContainerHeight+"px"},e._l(e.messages,function(t,a){return s("div",{key:t.id},[e.messages[a-1]&&e.$formatDate(e.messages[a-1].sentAt,"DD, MMM")===e.$formatDate(t.sentAt,"DD, MMM")?e._e():s("q-chat-message",{attrs:{label:e.$formatDate(t.sentAt,"DD, MMM")}}),s("q-chat-message",{ref:t.id,refInFor:!0,attrs:{sent:e.user.id===t.sentBy.userId,name:t.sentBy.name+" "+t.sentBy.lastName,text:[t.text],size:"5","text-color":e.user.id===t.sentBy.userId?"black":"white","bg-color":e.user.id===t.sentBy.userId?"white":"deep-purple-3",stamp:e.$dateFromNow(t.sentAt)}},[s("user-avatar",{staticClass:"q-mx-xs",attrs:{slot:"avatar","user-id":t.sentBy.userId,size:"48px"},slot:"avatar"})],1)],1)}),0),s("q-infinite-scroll",{ref:"chatContainerScroll",attrs:{reverse:"","scroll-target":e.$refs.chatContainer},on:{load:e.onLoad}})],1):e._e()],1)])},i=[],r=(s("7f7f"),s("7514"),s("1732")),n=s("808f"),o={name:"Chat",components:{UserAvatar:n["a"]},created:function(){var e=this;this.$q.screen.setSizes({sm:300,md:750,lg:1500,xl:3e3}),this.$store.dispatch("stomp/subscribe",{name:"message",destination:"/user/queue/message",callback:function(t){var s,a,i,r=JSON.parse(t.body);if(r.hash)e.$store.dispatch("chat/deleteSentMessage",r.hash),s=e.messages.find(function(e){return e.id===r.hash}),s.id=r.id,a=r.sendTo;else{if(r.sentBy.userId===e.activeFriend.id){e.messages.push(r);var n=e.$getStompHeaders();n.id="".concat(e.user.username,"-read-message"),e.$store.dispatch("stomp/send",{destination:"/ws/read-message",body:r.id,headers:n})}else i=!0;s=r,a=r.sentBy.userId}var o=e.friends.find(function(e){return e.user.id===a});o.lastMessage=s,i&&(o.unreadMessages+=1),e.scrollChatToBottom()}}),this.$axios.get("relationships/friends").then(function(t){e.friends=t.data,e.$q.platform.is.desktop&&e.friends.length>0&&e.friendSelect(e.friends[0])});var t=1e3,s=60*t;setInterval(function(){return e.updateMessages()},s)},data:function(){var e,t,s=this.$q.screen.lt;return this.$q.platform.is.desktop?s.lg?(e=600,t=500):s.xl&&(e=750,t=650):(e=this.$q.screen.height-50,t=this.$q.screen.height-50),{user:this.$store.getters["auth/getAccount"],friends:[],activeFriend:{},messages:[],textMessage:"",sendingMessage:!1,limit:void 0,dom:{divSize:e,chatContainerHeight:t}}},methods:{friendSelect:function(e){var t=this;this.activeFriend=e.user,this.limit=0,this.messages=[],this.$q.platform.is.desktop||(this.$root.$emit("addBackButton",function(){t.activeFriend={}}),this.$root.$emit("addTitle",{avatar:this.activeFriend.id,title:"".concat(this.activeFriend.name," ").concat(this.activeFriend.lastName),clearOnBack:!0}));var s=this.$refs.chatContainerScroll;s&&(s.resume(),s.poll())},sendMessage:function(){var e=this.textMessage;this.textMessage="";var t=this.$getStompHeaders();t.id="".concat(this.user.username,"-send-message");var s={hash:Object(r["a"])(),chatGroup:null,text:e,sendTo:this.activeFriend.id,isGroup:!1,isSent:!1};this.$store.dispatch("stomp/send",{destination:"/ws/message",body:s,headers:t}),this.$store.dispatch("chat/sendMessage",s),this.messages.push({id:s.hash,chatGroup:null,excludedAt:null,isGroup:!1,readBy:[],readByAll:!1,sentAt:new Date,sentBy:{userId:this.user.id,name:this.user.name,lastName:this.user.lastName},sentTo:[{userId:this.activeFriend.id,name:this.activeFriend.name,lastName:this.activeFriend.lastName}],text:s.text,updatedAt:null}),this.scrollChatToBottom()},scrollChatToBottom:function(){var e=this;setTimeout(function(){e.$refs.chatContainer.scrollTop=e.$refs.chatContainer.scrollHeight,e.$q.platform.is.desktop||window.scrollTo(0,document.body.scrollHeight)},0)},updateMessages:function(e,t,s){var a=this;this.activeFriend.id&&this.$axios.get("chat/private/".concat(this.user.id,"/").concat(this.activeFriend.id,"/messages"),{params:{limit:this.limit+(e||0)}}).then(function(e){a.messages=e.data.messages.reverse(),a.limit=e.data.limit,s&&(a.friends.find(function(e){return e.user.id===a.activeFriend.id}).unreadMessages=0,a.scrollChatToBottom()),a.messages.length===a.limit&&a.$refs.chatContainerScroll.stop(),"function"===typeof t&&t()})},onLoad:function(e,t){var s=!this.limit;this.limit=this.limit||0,this.activeFriend&&this.activeFriend.id?this.updateMessages(30,t,s):t()}}},l=o,d=(s("52f1"),s("2877")),c=Object(d["a"])(l,a,i,!1,null,"04441543",null);t["default"]=c.exports},"808f":function(e,t,s){"use strict";var a=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("q-avatar",{attrs:{size:e.size}},[s("q-img",{staticClass:"full-height",attrs:{src:e.avatarUrl+e.userId,"spinner-color":"accent"},scopedSlots:e._u([{key:"error",fn:function(){return[s("div",{staticClass:"absolute-full text-white flex justify-center",staticStyle:{padding:"0"}},[s("q-icon",{staticClass:"full-height",style:"font-size: "+e.size,attrs:{name:"account_circle"}})],1)]},proxy:!0}])})],1)},i=[],r=(s("c5f6"),{props:{userId:Number,size:{type:String,default:"60px"}},data:function(){return{avatarUrl:"".concat("https://intouristing-api.herokuapp.com/","users/avatar/")}}}),n=r,o=s("2877"),l=Object(o["a"])(n,a,i,!1,null,null,null);t["a"]=l.exports},"8ae4":function(e,t,s){}}]);